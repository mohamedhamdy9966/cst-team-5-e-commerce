<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Users Panel</title>
    <link
      rel="icon"
      type="image/x-icon"
      href="../assets/home/favicon (1).ico"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!--Toastify-->
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <!-- <script src="../JS/chechout.js"></script> -->
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/toastify-js"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jshashes/1.0.8/hashes.min.js"></script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        margin: 0;
        overflow-x: hidden;
      }

      .sidebar {
        background-color: #036280;
        color: white;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 400px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        z-index: 1000;
      }

      .sidebar .nav-link {
        color: white;
        background-color: #0f84a9;
        margin: 20px auto;
        text-align: center;
        width: 50%;
        border-radius: 20px;
        font-size: 1.25rem;
        padding: 10px 20px;
      }

      .sidebar .nav-link:hover {
        background-color: #0c6c8a;
        box-shadow: 4px 4px 4px 4px rgba(36, 19, 194, 0.3);
      }

      .main-content {
        margin-left: 400px;
        padding: 2rem;
      }

      .header {
        background: white;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        position: sticky;
        top: 0;
        z-index: 999;
        text-align: center;
      }

      .user-table th {
        background: #0c6c8a;
        color: white;
      }

      .user-table td,
      .user-table th {
        vertical-align: middle;
        text-align: center;
      }

      @media (max-width: 1281px) {
        .sidebar {
          width: 330px;
        }

        .main-content {
          margin-left: 300px;
        }

        .table {
          font-size: 0.8rem;
        }
      }

      @media (max-width: 768px) {
        .sidebar {
          flex-direction: row;
          justify-content: space-around;
          width: 100%;
          height: auto;
          position: fixed;
          top: 0;
          left: 0;
          padding: 0.5rem;
        }

        .sidebar span {
          display: none;
        }

        .sidebar .nav-link {
          margin: 0;
          width: 50px;
          height: 50px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .main-content {
          margin-left: 0 !important;
          padding-top: 5rem;
        }

        .user-table {
          font-size: 0.7rem;
        }

        .user-table i {
          font-size: 8px;
        }

        @media (max-width: 380px) {
          #gg {
            font-size: 0.5rem;
          }
        }
      }

      h5[class="modal-title"] {
        color: #036280;
      }

      button[type="submit"] {
        background-color: #036280;
        color: white;
      }

      button[type="submit"]:hover {
        background-color: #f4c430;
        color: white;
      }
      .sidebar {
        background-color: #036280;
        color: white;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 400px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        z-index: 1000;
      }
      .sidebar .nav-link {
        color: white;
        background-color: #0f84a9;
        margin: 20px auto;
        text-align: center;
        width: 50%;
        border-radius: 20px;
        font-size: 1.25rem;
        padding: 10px 20px;
      }
      .sidebar .nav-link:hover {
        background-color: #0c6c8a;
        box-shadow: 4px 4px 4px 4px rgba(36, 19, 194, 0.3);
      }
      .sidebar span,
      .sidebar i {
        color: white;
      }
      /* #adminAddUserButton:hover {
        background: #f4c430;
      } */
    </style>
    <style>
      body {
        margin: 0;
        font-family: "Poppins", sans-serif;
        overflow-x: hidden;
      }
      .sidebar {
        background-color: #036280;
        color: white;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 400px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        z-index: 1000;
      }
      .sidebar .nav-link {
        color: white;
        background-color: #0f84a9;
        margin: 20px auto;
        text-align: center;
        width: 50%;
        border-radius: 20px;
        font-size: 1.25rem;
        padding: 10px 20px;
      }
      .sidebar .nav-link:hover {
        background-color: #0c6c8a;
        box-shadow: 4px 4px 4px 4px rgba(36, 19, 194, 0.3);
      }
      .main-content {
        margin-left: 400px;
        padding: 2rem;
      }
      .header {
        background: white;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        position: sticky;
        top: 0;
        z-index: 999;
      }
      .chart-container {
        position: relative;
        height: 70vh;
        width: 100%;
        margin-top: 2rem;
      }

      @media (max-width: 768px) {
        .sidebar {
          height: auto;
          width: 100%;
          flex-direction: row;
          justify-content: space-around;
          padding: 0.5rem;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
        }
        .sidebar span {
          display: none;
        }
        .sidebar .nav-link {
          margin: 0;
          border-radius: 50%;
          width: 50px;
          height: 50px;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .main-content {
          margin-left: 0;
          padding-top: 4rem;
        }
        .chart-container {
          height: 50vh;
        }
      }
    </style>
  </head>

  <body>
    <!-- Sidebar -->
    <nav class="sidebar">
      <a href="./adminAddBook.html" class="nav-link ff15" title="Add Items"
        ><i class="bi bi-plus-square"></i><span> Sell A Book</span></a
      >
      <a href="./adminBookList.html" class="nav-link" title="List Items"
        ><i class="bi bi-list-ul"></i><span> Books list</span></a
      >
      <a href="./adminOrders.html" class="nav-link" title="Orders"
        ><i class="bi bi-receipt"></i><span> All Orders</span></a
      >
      <a href="./adminUsers.html" class="nav-link" title="Orders"
        ><i class="bi bi-person-lines-fill"></i><span> All Users</span></a
      >
      <a href="./adminAnalytics.html" class="nav-link" title="Analytics"
        ><i class="bi bi-bar-chart-line-fill"></i><span> My Analytics</span></a
      >
      <a href="./adminCustomerService.html" class="nav-link" title="Analytics"
        ><i class="bi bi-person-workspace"></i
        ><span> Customer Service </span></a
      >
      <a href="../index.html" class="nav-link" title="Logout" onclick="logout()"
        ><i class="bi bi-box-arrow-right"></i><span> LogOut</span></a
      >
    </nav>
    <!-- Main Content -->
    <main class="main-content text-center">
      <section
        class="header rounded text-light"
        style="background-color: #0f84a9"
      >
        <h3>All Users</h3>
      </section>
      <section class="user-list-container mt-4">
        <table class="table table-striped user-table" id="gg">
          <thead class="table-light">
            <tr>
              <th>UserName</th>
              <th>Email</th>
              <th>User Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
      <section
        class="w-25 p-1 mx-auto text-center btn border rounded my-3 p-3 fw-bold text-light"
        style="background-color: #036280"
        id="adminAddUserButton"
      >
        Add User
      </section>
    </main>
    <section
      class="modal fade"
      id="editUserModal"
      tabindex="-1"
      aria-labelledby="editUserModalLabel"
      aria-hidden="true"
    >
      <section class="modal-dialog">
        <section class="modal-content">
          <form id="editForm">
            <section class="modal-header">
              <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </section>
            <section class="modal-body">
              <input type="hidden" id="editIndex" />
              <section class="mb-3">
                <label for="editFirstName" class="form-label">First Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="editFirstName"
                  required
                />
              </section>
              <section class="mb-3">
                <label for="editLastName" class="form-label">Last Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="editLastName"
                  required
                />
              </section>
              <section class="mb-3">
                <label for="editEmail" class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="editEmail"
                  required
                  disabled
                />
              </section>
              <section class="mb-3">
                <label for="editPassword" class="form-label">Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="editPassword"
                  required
                />
              </section>
              <section class="mb-3">
                <label for="editRole" class="form-label">Role</label>
                <select class="form-select" id="editRole" required>
                  <option value="seller">Seller</option>
                  <option value="customer">Customer</option>
                </select>
              </section>
            </section>
            <section class="modal-footer">
              <button type="submit" class="btn btn-primary">
                Save Changes
              </button>
            </section>
          </form>
        </section>
      </section>
    </section>
    <script>
      const u = JSON.parse(localStorage.getItem("currentUser")) || {};
      const adminAddUserButton = document.getElementById("adminAddUserButton");
      if (!u || u.role !== "admin") {
        Toastify({
          text: " Access Denied !",
          duration: 3000,
          gravity: "top",
          position: "center",
          backgroundColor: "red",
        }).showToast();
        window.location.href = "../pages/login.html";
      }
      const users = JSON.parse(localStorage.getItem("users")) || [];
      if (users.length === 0) {
        const dummyUsers = [
          {
            firstName: "admin",
            lastName: "admin",
            email: "admin@iti.com",
            role: "admin",
          },
          {
            firstName: "seller",
            lastName: "seller",
            email: "seller@iti.com",
            role: "seller",
          },
          {
            firstName: "customer",
            lastName: "customer",
            email: "customer@iti.com",
            role: "admin",
          },
        ];
        localStorage.setItem("users", JSON.stringify(dummyUsers));
        location.reload();
      }
      const tbody = document.querySelector("tbody");
      tbody.innerHTML = "";
      users.forEach((user, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
        <td>${user.firstName + " " + user.lastName}</td>
        <td>${user.email}</td>
        <td>${user.role}</td>
        <td>
          <button class="btn btn-sm" style="background-color:#f4c430 ;" onclick="editUser(${index})">
  <i class="bi bi-pencil-square text-light"></i>
</button>
<button class="btn btn-sm" onclick="deleteUser(${index})" style="background-color: #e74c3c; color: white;">
  <i class="bi bi-trash"></i>
</button>

        </td>
      `;
        tbody.appendChild(row);
      });
      function deleteUser(index) {
        if (users[index].role === "admin") {
          Toastify({
            text: " Can't delete the admin Account !",
            duration: 3000,
            gravity: "top",
            position: "center",
            backgroundColor: "red",
          }).showToast();
          return;
        }
        if (confirm("Are you sure you want to delete this user?")) {
          users.splice(index, 1);
          localStorage.setItem("users", JSON.stringify(users));
          location.reload();
        }
      }
      function editUser(index) {
        const user = users[index] || {};
        if (user.role === "admin") {
          Toastify({
            text: " Can't edit the admin account !",
            duration: 3000,
            gravity: "top",
            position: "center",
            backgroundColor: "red",
          }).showToast();
          return;
        }
        document.getElementById("editIndex").value = index;
        document.getElementById("editFirstName").value =
          user.firstName || user.fname;
        document.getElementById("editLastName").value =
          user.lastName || user.lname;
        document.getElementById("editEmail").value = user.email;
        document.getElementById("editPassword").value = user.password;
        document.getElementById("editRole").value = user.role;
        const modal = new bootstrap.Modal(
          document.getElementById("editUserModal")
        );
        modal.show();
      }
      adminAddUserButton.addEventListener("click", addUser);
      function addUser() {
        document.getElementById("editIndex").value = users.length + 1;
        document.getElementById("editFirstName").value = "";
        document.getElementById("editLastName").value = "";
        document.getElementById("editEmail").value = "";
        document.getElementById("editPassword").value = "";
        document.getElementById("editRole").value = "";
        const modal = new bootstrap.Modal(
          document.getElementById("editUserModal")
        );
        modal.show();
      }

      document
        .getElementById("editForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const index = parseInt(
            document.getElementById("editIndex").value,
            10
          );
          const firstName = document
            .getElementById("editFirstName")
            .value.trim();
          const lastName = document.getElementById("editLastName").value.trim();
          const email = document.getElementById("editEmail").value.trim();
          const password = document.getElementById("editPassword").value.trim();
          const role = document.getElementById("editRole").value;
          if (!firstName || !lastName || !email || !password || !role) {
            Toastify({
              text: " All Fields required !",
              duration: 3000,
              gravity: "top",
              position: "center",
              backgroundColor: "red",
            }).showToast();
            return;
          }
          const SHA256 = new Hashes.SHA256();
          const hashedPassword = SHA256.hex(password);
          const updatedUser = { firstName, lastName, email, role, password: password ? sha256(password) : users[index]?.password || "" };
          if (index >= users.length) {
            // Add new user
            users.push(updatedUser);
            Toastify({
              text: " User Added Successfully !",
              duration: 3000,
              gravity: "top",
              position: "center",
              backgroundColor: "green",
            }).showToast();
          } else {
            // Update existing user
            if (users[index].role === "admin") {
              Toastify({
                text: " can't edit the admin account !",
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "red",
              }).showToast();
              return;
            }
            users[index] = updatedUser;
            Toastify({
              text: " User Updated Successfully !",
              duration: 3000,
              gravity: "top",
              position: "center",
              backgroundColor: "green",
            }).showToast();
          }
          localStorage.setItem("users", JSON.stringify(users));
          location.reload();
        });
      // Logout function
      function logout() {
        localStorage.removeItem("currentUser");
        Toastify({
          text: "Logged Out Successfully.",
          duration: 3000,
          gravity: "top",
          position: "center",
          backgroundColor: "green",
        }).showToast();
        setTimeout(() => {
          window.location.href = "../index.html";
        }, 1000);
      }
    </script>
  </body>
</html>
